<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        body {
            margin-left: 0;
        }
    </style>
</head>
<body id="body">
    <div id="the-bar">
        <div id="leaderboard-wrapper" onclick="window.location = './leaderboard.html'">
            Leaderboard
        </div>
        <div id="logout-wrapper" onclick="logout()">
            Logout
        </div>
        <div id="home-wrapper" onclick="window.location = './index.html'">
            Home
        </div>
        <div id="points-wrapper">
            Points: 
        </div>
    </div>
</body>
<script type="module">
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js'
    import { doc, getDoc, getFirestore, updateDoc, increment, collection, getDocs, query } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js'
    
    const firebaseConfig = {
        apiKey: "AIzaSyD7USXryTnEIHRxISXxCOQdyD4q7puHuvw",
        authDomain: "codezonehs.firebaseapp.com",
        projectId: "codezonehs",
        storageBucket: "codezonehs.firebasestorage.app",
        messagingSenderId: "564878006133",
        appId: "1:564878006133:web:3acb0b826b57a03943e53c",
        measurementId: "G-B6CZYS7LRS"
    };

    const app = initializeApp(firebaseConfig);

    const auth = getAuth(app);

    const db = getFirestore(app);

    const settingsSnap = await getDoc(doc(db, "settings", "settings"))
    if(!settingsSnap.data().leaderboard) {
        window.location = "./index.html"
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDoc);
            const userDocData = userDocSnap.data()

            document.getElementById("points-wrapper").textContent = "Points: " + userDocData["points"]
        } else {
            window.location = "./signin.html"
        }
    });

    function logout() {
        signOut(auth);
    }
    
    const userDocsRef = query(collection(db,"users"))
    const userDocs = await getDocs(userDocsRef)

    const users = []

    userDocs.forEach((userDoc) => {
        users.push(userDoc.data())
    })

    users.sort((a, b) => b.points - a.points);

    users.forEach((user) => {
        if(!user.isAdmin) {
            const teamContainer = document.createElement("div")
            teamContainer.className = "team-container"
            teamContainer.textContent = user.username + ": " + user.points

            document.getElementById("body").appendChild(teamContainer)
        }
    })

    window.logout = logout
</script>
</html>
