<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        .break {
            height: 2px;
        }
        body {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="problemNum" style="width: 100%; font-weight: 750;"></div>
    <div id="add-problem-container">
        <div style="font-weight: 750; width: 100%;">
            Add problem
        </div>
        <input placeholder="ID" id="id">
        <div class="break"></div>
        <input placeholder="Name" id="name">
        <div class="break"></div>
        <input placeholder="Description" id="desc">
        <div class="break"></div>
        <input placeholder="Difficulty" id="diff">
        <div class="break"></div>
        <input placeholder="Test input 1" id="test1">
        <div class="break"></div>
        <input placeholder="Test input 2" id="test2">
        <div class="break"></div>
        <input placeholder="Test input 3" id="test3">
        <div class="break"></div>
        <input type="file" id="add-problem-file-inp">
        <div class="break"></div>
        <button onclick="addProblem()">ADD</button>
    </div>
    <div id="leaderboard-buttons-container">
        <button class="leaderboard-button" onclick="changeLeaderboard(false)">Disable Leaderboard</button>
        <button class="leaderboard-button" onclick="changeLeaderboard(true)">Enable Leaderboard</button>
    </div>
    <div id="query-uid-container">
        <input placeholder="Query UID by Username" style="margin-right: 10px;" id="query-uid-input">
        <button onclick="queryUid()">Query</button>
    </div>
</body>
<script type="module">
    import { runPython } from "./pyjs.js"
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js'
    import { doc, getDoc, getFirestore, updateDoc, increment, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js'
    
    const firebaseConfig = {
        apiKey: "AIzaSyD7USXryTnEIHRxISXxCOQdyD4q7puHuvw",
        authDomain: "codezonehs.firebaseapp.com",
        projectId: "codezonehs",
        storageBucket: "codezonehs.firebasestorage.app",
        messagingSenderId: "564878006133",
        appId: "1:564878006133:web:3acb0b826b57a03943e53c",
        measurementId: "G-B6CZYS7LRS"
    };

    const app = initializeApp(firebaseConfig);

    const auth = getAuth(app);

    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDoc);
            const isAdmin = userDocSnap.data()["isAdmin"]
            if(!isAdmin) { window.location = "./index.html" }
        } else {
            window.location = "./signin.html"
        }
    });

    async function addProblem(params) {
        const fileInp = document.getElementById("add-problem-file-inp")
        const file = fileInp.files[0]; // Get the first selected file
        const testInps = [document.getElementById("test1").value,document.getElementById("test2").value,document.getElementById("test3").value]
        var testOuts = []
        if (file) {
            const reader = new FileReader();

            reader.onload = async function(event) {
                testOuts.push(await runPython(event.target.result, testInps[0]))
                testOuts.push(await runPython(event.target.result, testInps[1]))
                testOuts.push(await runPython(event.target.result, testInps[2]))

                const id = document.getElementById("id").value
                const name = document.getElementById("name").value
                const diff = parseInt(document.getElementById("diff").value)
                const desc = document.getElementById("desc").value
                var data = {}
                data[id] = {"NAME":name, "DIFF":diff, "DESC":desc}
                console.log(testOuts)
                data[id][testInps[0]] = testOuts[0]
                data[id][testInps[1]] = testOuts[1]
                data[id][testInps[2]] = testOuts[2]
                console.log(data)
                await updateDoc(doc(db, "problems", "problems"), data)
            };
            reader.readAsText(file);
        }
    }

    window.addProblem = addProblem

    async function changeLeaderboard(val) {
        await updateDoc(doc(db, "settings", "settings"), {leaderboard: val})
    }

    window.changeLeaderboard = changeLeaderboard

    async function queryUid() {
        const username = document.getElementById("query-uid-input").value
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));

        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
            console.log(doc.id, " => ", doc.data());
        });
    }

    window.queryUid = queryUid

    const problems = await getDoc(doc(db,"problems","problems"))
    const problemsLength = Object.keys(problems.data()).length
    document.getElementById("problemNum").textContent = "# Problems: " + problemsLength

</script>
</html>
