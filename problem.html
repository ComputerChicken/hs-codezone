<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Comp</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body style="overflow: hidden; height: 100vh;">
    <div id="the-bar">
        <div id="leaderboard-wrapper" onclick="window.location = './leaderboard.html'">
            Leaderboard
        </div>
        <div id="logout-wrapper" onclick="logout()">
            Logout
        </div>
        <div id="home-wrapper" onclick="window.location = './index.html'">
            Home
        </div>
    </div>
    <div style="width: 100%; display: flex; justify-content: center;">
        <div>
            <div style="display: flex; justify-content: right; width: 100%; margin-left: 40px;">
                <input type="file" accept=".py" id="file-input">
            </div>
            <div style="display: flex; justify-content: center; width: 100%;">
                <div id="correct" style="margin-top: 10px; height: 30px; width: 120px; font-size: 20px; border-radius: 20px;"></div>
            </div>
        </div>
    </div>
    <div style="position: fixed; top: 0; left: 0; height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; z-index: -1;">
        <div id="desc-box">
        </div>
    </div>
</body>
<script type="module">
    import { check } from "./pyjs.js"

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const problemName = urlParams.get('name');
    console.log(problemName)

    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js'
    import { doc, getDoc, getFirestore, updateDoc, increment } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js'
    
    const firebaseConfig = {
        apiKey: "AIzaSyD7USXryTnEIHRxISXxCOQdyD4q7puHuvw",
        authDomain: "codezonehs.firebaseapp.com",
        projectId: "codezonehs",
        storageBucket: "codezonehs.firebasestorage.app",
        messagingSenderId: "564878006133",
        appId: "1:564878006133:web:3acb0b826b57a03943e53c",
        measurementId: "G-B6CZYS7LRS"
    };

    const app = initializeApp(firebaseConfig);

    const auth = getAuth(app);

    const db = getFirestore(app);

    const docRef = doc(db, "problems", "problems");
    const docSnap = await getDoc(docRef);
    const docData = docSnap.data();

    document.getElementById("desc-box").innerHTML = "Description:<br><br>" + docData[problemName]["DESC"] + "<br><br>Example Input:<br>"

    var exampleInput = ""

    var exampleOutput = ""

    var keys = Object.keys(docData[problemName])

    keys.sort((a, b) => a.localeCompare(b));

    keys.forEach((key) => {
        if(key != "NAME" && key != "DIFF" && key != "DESC") {
            exampleInput = key
        }
        if(key != "NAME" && key != "DIFF" && key != "DESC") {
            exampleOutput = docData[problemName][key]
        }
    })

    exampleInput = exampleInput.replaceAll("|||","<br>")
    exampleOutput = exampleOutput.replaceAll("\n","<br>")

    document.getElementById("desc-box").innerHTML += exampleInput + "<br><br>Example Output:<br>" + exampleOutput

    var uid;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            uid = user.uid;
        } else {
            window.location = "./signin.html"
        }
    });

    function logout() {
        signOut(auth);
    }

    window.logout = logout

    const fileInp = document.getElementById("file-input")
    fileInp.addEventListener("change", function() {
    const file = this.files[0]; // Get the first selected file
    if (file) {
        const reader = new FileReader();

        reader.onload = async function(event) {
            await check(problemName, event.target.result).then(async (result) => {
                console.log(result)
                if(result) {
                    const correctEl = document.getElementById("correct")
                    correctEl.textContent = "Correct"
                    correctEl.className = "Easy-wrapper"

                    const userSnap = await getDoc(doc(db, "users", uid))
                    var problemsDone = userSnap.data()["problemsDone"]

                    console.log(problemsDone)

                    var toInc = 0;

                    if(!problemsDone.includes(problemName)) {
                        toInc = parseInt(docData[problemName]["DIFF"]) + 1
                        problemsDone.push(problemName)
                    }

                    await updateDoc(doc(db, "users", uid), {points: increment(toInc), problemsDone: problemsDone})
                } else {
                    const correctEl = document.getElementById("correct")
                    correctEl.textContent = "Incorrect"
                    correctEl.className = "Hard-wrapper"
                }
            })
        };

        reader.readAsText(file);
    }
    });
</script>
</html>